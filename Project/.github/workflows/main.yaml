name: Release application

on:
  push:

env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  GKE_CLUSTER: dwk-cluster
  GKE_ZONE: europe-north1-b
  REGISTRY: europe-north1-docker.pkg.dev
  BACKEND_REPO: backend-repo
  FRONTEND_REPO: frontend-repo
  BACKEND_IMAGE: backend-todo
  FRONTEND_IMAGE: frontend-todo
  BACKEND_DEPLOY: backend-deployment
  FRONTEND_DEPLOY: project-dep
  BRANCH: ${{ github.ref_name }}

jobs:
  build-publish-deploy:
    name: Build, Publish and Deploy
    runs-on: ubuntu-latest

    steps:
    # 1. Get your code
    - name: Checkout
      uses: actions/checkout@v4

    # 2. Login to Google Cloud
    - uses: google-github-actions/auth@v2
      with:
        credentials_json: '${{ secrets.GKE_SA_KEY }}'

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    # 3. Allow Docker to push to Artifact Registry
    - name: Configure Docker for Artifact Registry
      run: gcloud --quiet auth configure-docker $REGISTRY

    # 4. Connect to your GKE cluster
    - name: Get GKE credentials
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        project_id: ${{ env.PROJECT_ID }}
        location: ${{ env.GKE_ZONE }}

    # 5. Form image tags
    - name: Form backend image name
      run: echo "BACKEND_TAG=$REGISTRY/$PROJECT_ID/$BACKEND_REPO/$BACKEND_IMAGE:$BRANCH-$GITHUB_SHA" >> $GITHUB_ENV

    - name: Form frontend image name
      run: echo "FRONTEND_TAG=$REGISTRY/$PROJECT_ID/$FRONTEND_REPO/$FRONTEND_IMAGE:$BRANCH-$GITHUB_SHA" >> $GITHUB_ENV

    # 6. Build images
    - name: Build backend image
      run: docker build ./Backend_todo -t $BACKEND_TAG

    - name: Build frontend image
      run: docker build ./Frontend_todo -t $FRONTEND_TAG

    # 7. Push images
    - name: Push backend image
      run: docker push $BACKEND_TAG

    - name: Push frontend image
      run: docker push $FRONTEND_TAG

    # 8. Set up Kustomize
    - name: Set up Kustomize
      uses: imranismail/setup-kustomize@v2.1.0

    # 9. Deploy updated images
    - name: Deploy to GKE
      run: |
        # Update Kustomize image refs
        kustomize edit set image PROJECT/BACKEND=$BACKEND_TAG
        kustomize edit set image PROJECT/FRONTEND=$FRONTEND_TAG

        # Apply to cluster
        kustomize build . | kubectl apply -f -

        # Wait for rollouts
        kubectl rollout status deployment $BACKEND_DEPLOY -n project
        kubectl rollout status deployment $FRONTEND_DEPLOY -n project

        # Show services
        kubectl get svc -n project -o wide
